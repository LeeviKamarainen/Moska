
if (document.readyState !== "loading") {
    initializeCode();
    console.log('Loading!')
  } else {
    document.addEventListener("DOMContentLoaded", function () {
      initializeCode();
    });
  }
  
  async function initializeCode() {
    const playCardsButton = document.getElementById("play-fall-hand");
    const playCardsArray = Object.create(null);
    console.log("Code initialized!")
    const res = await fetch("./example_state.json");
    let stateJson = await res.json();
    updateState(stateJson)

    // Add click listener to the document:
    document.body.onclick = function(e){
      if(e.target.className && e.target.className.indexOf('card')!=-1 && e.target.getAttribute("parentcontainer") == "bottom") {
        console.log(e.target)
        if(e.target.hasAttribute('selected')==true) {
          //e.target.removeAttribute('selected')
          delete playCardsArray[e.target.getAttribute('card-type')];
        } else {
       // e.target.setAttribute('selected',1)
        console.log(e.target.getAttribute('card-type'))
        playCardsArray[e.target.getAttribute('card-type')] = 1;
        }
      }
   }

   checkActionState(stateJson)
   playCardsButton.addEventListener("click", function(){
    stateJson.action = "PlayFallFromHand"
    playCards(stateJson)
  });
  

  }


function checkActionState(stateJson) {
  const actionMenuButtons = document.getElementsByClassName("play-cards");
  console.log(actionMenuButtons)

  // First make sure that all of the buttons are hidden (if they have previously been unhidden.)
  for (let index = 0; index < actionMenuButtons.length; index++) {
    actionMenuButtons[index].disabled = true;
  }

  // Find initiators name:
  let playerName = stateJson.initiator.split(/(\d+)/); 
  // Then make all of the buttons which are included in the stateJson visible:
  for (let index = 0; index < actionMenuButtons.length; index++) {
    // Check if they initiator actions includes the buttons id and that the player is also human.
    if(stateJson.initiator_actions.includes(actionMenuButtons[index].id) && playerName[0]!="NNEV") {
      actionMenuButtons[index].disabled = false; 
    }
  }
}


function playCards(stateJson) {
  // Find player name:
  let humanName;
  for (let playerIndex = 0; playerIndex < stateJson.players.length; playerIndex++) {
    //Splitting the players name by first numeric character
    let playerName = stateJson.players[playerIndex].name.split(/(\d+)/); 
    if(playerName[0]!="NNEV"){ // Player is human:
      humanName = stateJson.players[playerIndex].name;
     }
  }

  //Case when human plays :
  if(stateJson.action == "PlayFallFromHand") {
    let cardArray = ["PlayFallFromHand"];
    let index = 1;
    playFallHand(function(temp){
      console.log(temp)
      return temp;
    });

  }

  // Case when human is the target:
  if(stateJson.target == humanName) {

  }

}


function playFallHand(callback) {

  cardArray = ["PlayFallFromHand"];
  index = 1;
  createHand(cardArray,index,callback);
  function createHand(cardArray,index) {
  let cardPair = "";
  console.log(cardArray)

  // Check if the user wants to play the cards (end recursion):
  const playCardsButton = document.getElementById("play-fall-hand");
  playCardsButton.innerHTML = 'Play selected cards';
  playCardsButton.addEventListener("click", function(){
    playCardsButton.innerHTML = 'Select Fall from Hand';
    callback(cardArray);
    index = 101;
   });

   if(index > 100) {
    return;
   }
  let humanDeck = document.getElementById('bottom')
  let board = document.getElementById('middle')
  
  humanDeck.setAttribute('activated',1)

  humanDeck.onclick = function(e){
    if(e.target.className && e.target.className.indexOf('card')!=-1  && e.target.getAttribute('card-type') != null && humanDeck.getAttribute('activated') == 1) {
      cardPair = cardPair.concat(e.target.getAttribute('card-type'));
      let cardToPlay = e.target;
      cardToPlay.setAttribute('selected',1);
      console.log(cardPair);
    
    board.setAttribute('activated',1)
    humanDeck.removeAttribute('activated');
    humanDeck.removeAttribute('onclick');
    board.onclick = function(e){
      if(e.target.className && e.target.className.indexOf('card')!=-1 && e.target.getAttribute('card-type') != null && board.getAttribute('activated') == 1) {
        let cardToFall = e.target;
        cardToFall.setAttribute('selected',1);
        
        // Concat the card pair to string:
        cardPair = cardPair.concat(","+e.target.getAttribute('card-type'));
        cardArray.push(cardPair);
        
        board.removeAttribute('activated')
        
        // Set the selected cards as unactivated:
        cardToFall.removeAttribute('selected')
        cardToPlay.removeAttribute('selected')
        
        cardToFall.setAttribute('used',1)
        cardToPlay.setAttribute('used',1)
        return createHand(cardArray,index+1);
          }}
    }
  }
}
}


  function parseCard(cardString) {
    //This string parses given card string in to valid img src:
    const splitString = cardString.split(/(\d+)/);
    let cardName;
    if(splitString[0]=="H"){
    cardName = "hearts";
    }
    else if(splitString[0]=="C") {
      cardName = "clubs";
    }
    else if(splitString[0]=="S") {
      cardName = "spades";
    }
    else if(splitString[0]=="D") {
      cardName = "diamonds"
    }

    let cardNumber = splitString[1];
    let parsedString = cardNumber+"_of_"+cardName;
    let imgSrc = "/images/cards/"+parsedString+".png";
    return imgSrc;
  }


  function updateState(stateJson) {
    console.log(stateJson)
    let botIndex = 0;

    // Rendering players cards:
    for (let playerIndex = 0; playerIndex < stateJson.players.length; playerIndex++) {
    //Splitting the players name by first numeric character
    let playerName = stateJson.players[playerIndex].name.split(/(\d+)/); 
    let containerName;
    let cardContainer;
    if(playerName[0]!="NNEV"){ // Player is human:
      containerName = "bottom";
    } else { // If the player is a bot:
      switch (botIndex) {
        case 0: {
          containerName = "left";
          break;
        }
        case 1: {
          containerName = "top";
          break;
        }
        case 2: {
          containerName = "right";
          break;
        }
      }
      console.log(botIndex)
      botIndex = botIndex + 1;
    }
    cardContainer = document.getElementById(containerName);
    cardContainer.innerHTML = stateJson.players[playerIndex].name;
    // Add target attribute to the target players div:
    if(stateJson.players[playerIndex].name == stateJson.target) {
      cardContainer.setAttribute("target",1);
    }

    if(stateJson.players[playerIndex].name == stateJson.initiator) {
      cardContainer.setAttribute("initiator",1);
    }

    // Get the card container element

    // Selecting current indeces player:
    let playerState = stateJson.players[playerIndex];
    console.log(playerState)

    for (let index = 0; index < playerState.cards.length; index++) { // Loop through the cards:

      let cardString = playerState.cards[index];
      let parsedString = parseCard(cardString)

      // Create new card div
      const card = document.createElement("div");
      card.classList.add("card");

      // Create new image element for the card
      const cardImage = document.createElement("img");
      cardImage.src = parsedString;
      cardImage.className = "card";
      
      cardImage.setAttribute('parentContainer',containerName);
      cardImage.setAttribute('card-type',cardString);

      // Append the image, heading, and paragraph elements to the card element
      card.appendChild(cardImage);

      // Append the card element to the card container
      cardContainer.appendChild(card);
    }
    
  }

  // Rendering cards to kill:
  const boardContainer = document.getElementById("middle");
  for (let index = 0; index < stateJson.cards_to_kill.length; index++) {
    
    let cardString = stateJson.cards_to_kill[index];
    let parsedString = parseCard(cardString)

    // Create new card div
    const card = document.createElement("div");
    card.classList.add("card");

    // Create new image element for the card
    const cardImage = document.createElement("img");
    cardImage.src = parsedString;
    cardImage.className = "card";
    cardImage.setAttribute('card-type',cardString);

    // Append the image, heading, and paragraph elements to the card element
    card.appendChild(cardImage);

    // Append the card element to the card container
    boardContainer.appendChild(card);
    
  }

  // Rendering amount of cards left in the deck and the trump card:
  const deckContainer = document.getElementById("deck");
  // Create new card div
  const card = document.createElement("div");
  const card2 = document.createElement("div");
  card.classList.add("card");
  card2.classList.add("card");
  // Create new image element for the card
  const cardImage = document.createElement("img");
  const cardImage2 = document.createElement("img");
  cardImage.src = "/images/cards/card_back.png";
  cardImage.className = "card";
  cardImage.setAttribute('card-type',"card_back");

  let cardString = stateJson.trump_card;
  let parsedCard = parseCard(cardString);
  cardImage2.src = parsedCard;
  cardImage2.className = "card";
  cardImage2.setAttribute('card-type',"card_back");
  

  // Append the image, heading, and paragraph elements to the card element
  card.appendChild(cardImage);
  card2.appendChild(cardImage2);

  // Append the card elements to the card container
  const amountLeft = document.createElement("p");
  amountLeft.className = "amount-left";
  amountLeft.innerHTML = "Cards left: "+stateJson.deck_left;
  deckContainer.appendChild(card);
  deckContainer.appendChild(card2);
  deckContainer.appendChild(amountLeft);


  }